name: Deploy Hexo to GitHub Pages

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 只保留必需权限，减少干扰
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Node.js 16
        uses: actions/setup-node@v4
        with:
          node-version: '16'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: |
          npm config set registry https://registry.npmmirror.com
          npm install hexo-cli -g
          npm install --legacy-peer-deps
          npm install hexo-renderer-pug hexo-renderer-stylus --save

      - name: Generate static files
        run: |
          hexo clean
          hexo generate --debug
          echo "✅ 静态文件生成完成，目录结构："
          ls -la public/

      - name: Deploy to GitHub Pages (纯命令行认证)
        env:
          # 直接把 Secret 赋值给环境变量，强制传递
          PAT_TOKEN: ${{ secrets.HEXO_DEPLOY_TOKEN }}
          GITHUB_USER: liudungen
          TARGET_REPO: liudungen/liudungen.github.io
        run: |
          # 先验证环境变量是否拿到令牌（关键调试）
          echo "✅ 验证令牌是否存在：${PAT_TOKEN:0:5}..."  # 只显示前5位，避免泄露
          if [ -z "$PAT_TOKEN" ]; then
            echo "❌ ERROR: PAT_TOKEN 未读取到！"
            exit 1
          fi

          cd public
          git init
          git config user.name "$GITHUB_USER"
          git config user.email "798695922@qq.com"
          git add -A
          git commit -m "Deploy: $(date +'%Y-%m-%d %H:%M:%S')"

          # 用环境变量拼接 URL，避免任何参数误解
          REMOTE_URL="https://$GITHUB_USER:$PAT_TOKEN@github.com/$TARGET_REPO.git"
          echo "✅ 推送地址：${REMOTE_URL//$PAT_TOKEN/[TOKEN_HIDDEN]}"  # 隐藏令牌显示

          # 强制推送，禁用证书校验（避免云端网络兼容问题）
          GIT_SSL_NO_VERIFY=1 git push -f "$REMOTE_URL" main
