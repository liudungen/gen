# 验证主题目录是否存在（关键：确保布局模板存在）
if [ ! -d "themes/landscape" ]; then
  echo "❌ 主题 landscape 目录缺失，尝试重新克隆"
  rm -rf themes/landscape
  git clone https://github.com/hexojs/hexo-theme-landscape.git themes/landscape
fi

# ========== 修复配置 ==========
echo "=== 修复配置文件 ==="
# 1. 备份原配置
cp _config.yml _config.yml.backup

# 2. 创建干净的配置文件
cat > _config.yml << 'EOF'
title: Hexo
subtitle: ''
description: ''
keywords:
author: John Doe
language: zh-CN
timezone: Asia/Shanghai
url: https://liudungen.github.io

# URL 设置
permalink: :year/:month/:title/
permalink_defaults:
pretty_urls:
  trailing_index: true
  trailing_html: true

# 新文章名称
new_post_name: :title.md

# 主题
theme: landscape

# 生成器设置
index_generator:
  per_page: 10
  order_by: -date
archive_generator:
  per_page: 10
  yearly: true
  monthly: true
category_generator:
  per_page: 10
tag_generator:
  per_page: 10

# 其他设置
highlight:
  enable: true
EOF

echo "✅ 配置文件已重建"

# 3. 如果有自定义配置，合并
if [ -f "_config.yml.backup" ]; then
  echo "合并自定义配置..."
  # 保留重要的自定义设置（如果有）
  grep -E "^(title:|subtitle:|author:|language:|timezone:|url:|deploy:)" _config.yml.backup >> _config.yml 2>/dev/null || true
fi

# 4. 删除默认文章
echo "删除默认文章..."
rm -f source/_posts/hello-world.md 2>/dev/null || echo "无默认文章"

# 5. 显示最终配置
echo "最终配置预览:"
grep -E "^(permalink|pretty_urls|theme|new_post_name)" _config.yml
# ========== 修复结束 ==========

# 生成静态文件（增加调试日志，定位布局问题）
hexo clean
hexo generate --force --debug
