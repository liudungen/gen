name: Deploy Hexo to GitHub Pages
on:
  push:
    branches: [main]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£… Hexo å¹¶ç”Ÿæˆé™æ€æ–‡ä»¶
        run: |
          set -euo pipefail
          REPO_ROOT=$(pwd)
          echo "âœ… ä»“åº“æ ¹ç›®å½•: $REPO_ROOT"
          
          # è®¾ç½® npm é•œåƒ
          npm config set registry https://registry.npmmirror.com
          
          # å…¨å±€å®‰è£… Hexo CLI
          npm install hexo-cli@4.3.2 -g
          
          # æ¸…ç†æ—§ç›®å½•
          rm -rf "$REPO_ROOT/temp-hexo"
          
          # åˆå§‹åŒ– Hexo
          hexo init "$REPO_ROOT/temp-hexo" --theme landscape
          cd "$REPO_ROOT/temp-hexo"
          
          # å®‰è£…ä¾èµ–
          npm install hexo@8.1.1 --legacy-peer-deps
          npm install hexo-renderer-pug hexo-renderer-stylus --save
          npm install hexo-theme-landscape --save
          
          # å¤åˆ¶è‡ªå®šä¹‰é…ç½®ï¼ˆè‹¥å­˜åœ¨ï¼‰
          if [ -f "$REPO_ROOT/_config.yml" ]; then
            cp "$REPO_ROOT/_config.yml" _config.yml
            echo "âœ… å·²å¤åˆ¶è‡ªå®šä¹‰é…ç½®"
          fi
          
          # éªŒè¯ä¸»é¢˜ç›®å½•æ˜¯å¦å­˜åœ¨ï¼ˆå…³é”®ï¼šç¡®ä¿å¸ƒå±€æ¨¡æ¿å­˜åœ¨ï¼‰
          if [ ! -d "themes/landscape" ]; then
            echo "âŒ ä¸»é¢˜ landscape ç›®å½•ç¼ºå¤±ï¼Œå°è¯•é‡æ–°å…‹éš†"
            rm -rf themes/landscape
            git clone https://github.com/hexojs/hexo-theme-landscape.git themes/landscape
          fi

          # ========== ä¿®å¤é…ç½®æ–‡ä»¶ ==========
          echo "=== ä¿®å¤é…ç½®æ–‡ä»¶ ==="
          # å¤‡ä»½åŽŸé…ç½®
          cp _config.yml _config.yml.backup
          
          # åˆ›å»ºå¹²å‡€çš„é…ç½®æ–‡ä»¶
          cat > _config.yml << 'EOF'
title: Hexo
subtitle: ''
description: ''
keywords:
author: John Doe
language: zh-CN
timezone: Asia/Shanghai
url: https://liudungen.github.io

# URL è®¾ç½®
permalink: :year/:month/:title/
permalink_defaults:
pretty_urls:
  trailing_index: true
  trailing_html: true

# æ–°æ–‡ç« åç§°
new_post_name: :title.md

# ä¸»é¢˜
theme: landscape

# ç”Ÿæˆå™¨è®¾ç½®
index_generator:
  per_page: 10
  order_by: -date
archive_generator:
  per_page: 10
  yearly: true
  monthly: true
category_generator:
  per_page: 10
tag_generator:
  per_page: 10

# å…¶ä»–è®¾ç½®
highlight:
  enable: true
EOF
          
          echo "âœ… é…ç½®æ–‡ä»¶å·²é‡å»º"
          
          # å¦‚æžœæœ‰è‡ªå®šä¹‰é…ç½®ï¼Œåˆå¹¶é‡è¦è®¾ç½®
          if [ -f "_config.yml.backup" ]; then
            echo "åˆå¹¶è‡ªå®šä¹‰é…ç½®..."
            # ä¿ç•™æ ‡é¢˜ã€ä½œè€…ç­‰é‡è¦è®¾ç½®
            CUSTOM_TITLE=$(grep -E "^title:" _config.yml.backup | head -1)
            CUSTOM_AUTHOR=$(grep -E "^author:" _config.yml.backup | head -1)
            CUSTOM_LANGUAGE=$(grep -E "^language:" _config.yml.backup | head -1)
            
            if [ ! -z "$CUSTOM_TITLE" ]; then
              sed -i "s/^title:.*/$CUSTOM_TITLE/" _config.yml
            fi
            if [ ! -z "$CUSTOM_AUTHOR" ]; then
              sed -i "s/^author:.*/$CUSTOM_AUTHOR/" _config.yml
            fi
            if [ ! -z "$CUSTOM_LANGUAGE" ]; then
              sed -i "s/^language:.*/$CUSTOM_LANGUAGE/" _config.yml
            fi
          fi
          
          # åˆ é™¤é»˜è®¤æ–‡ç« 
          rm -f source/_posts/hello-world.md 2>/dev/null || echo "æ— é»˜è®¤æ–‡ç« "
          
          # æ˜¾ç¤ºé…ç½®
          echo "é…ç½®é¢„è§ˆ:"
          grep -E "^(title|permalink|pretty_urls|theme)" _config.yml
          # ========== ä¿®å¤ç»“æŸ ==========
          
          # å¤åˆ¶æ–‡ç« ï¼ˆå®¹é”™é€»è¾‘ï¼‰
          mkdir -p source/_posts
          echo "=== å¤åˆ¶æ–‡ç« æ–‡ä»¶ ==="
          if [ -d "$REPO_ROOT/source/_posts" ] && [ "$(ls -A "$REPO_ROOT/source/_posts/")" ]; then
            echo "ðŸ“„ æºæ–‡ç« åˆ—è¡¨:"
            ls -la "$REPO_ROOT/source/_posts/"
            cp -r "$REPO_ROOT/source/_posts/"* source/_posts/
            echo "âœ… æ–‡ç« å¤åˆ¶å®Œæˆ"
          else
            echo "âš ï¸  æ— è‡ªå®šä¹‰æ–‡ç« ï¼Œåˆ›å»ºæµ‹è¯•æ–‡ç« "
            cat > source/_posts/æµ‹è¯•æ–‡ç« .md << 'EOF'
---
title: æµ‹è¯•æ–‡ç« 
date: 2025-12-03 16:00:00
tags: [Hexo, æµ‹è¯•]
categories: æ—¥è®°
layout: post
---
è¿™æ˜¯ GitHub Actions è‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯•æ–‡ç« ã€‚
éªŒè¯è·¯å¾„ï¼š2025/12/æµ‹è¯•æ–‡ç« /
éªŒè¯å¸ƒå±€ï¼špostï¼ˆlandscape ä¸»é¢˜é»˜è®¤å¸ƒå±€ï¼‰
EOF
          fi
          
          # ç”Ÿæˆé™æ€æ–‡ä»¶ï¼ˆå¢žåŠ è°ƒè¯•æ—¥å¿—ï¼‰
          echo -e "\n=== å¼€å§‹ç”Ÿæˆé™æ€æ–‡ä»¶ ==="
          hexo clean
          hexo generate --force --debug
          
          # éªŒè¯ç”Ÿæˆç»“æžœ
          echo -e "\n===== ç”Ÿæˆçš„é™æ€æ–‡ä»¶åˆ—è¡¨ ====="
          find public -type f -name "*.html" | head -20 || echo "âš ï¸  æœªç”Ÿæˆ HTML æ–‡ä»¶"
          
          if [ ! -d "public" ] || [ -z "$(ls -A public)" ]; then
            echo "âŒ Hexo ç”Ÿæˆå¤±è´¥ï¼Œpublic ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
            exit 1
          fi

      - name: å‡†å¤‡éƒ¨ç½²ç›®å½•
        run: |
          set -euo pipefail
          REPO_ROOT=$(pwd)
          echo "âœ… å½“å‰ä»“åº“æ ¹ç›®å½•: $REPO_ROOT"
          
          # æ¸…ç†æ—§çš„ public ç›®å½•
          rm -rf "$REPO_ROOT/public"
          
          # éªŒè¯ temp-hexo/public å­˜åœ¨
          if [ ! -d "$REPO_ROOT/temp-hexo/public" ]; then
            echo "âŒ temp-hexo/public ç›®å½•ä¸å­˜åœ¨ï¼Œéƒ¨ç½²ç»ˆæ­¢"
            exit 1
          fi
          
          # ç§»åŠ¨é™æ€æ–‡ä»¶åˆ°æ ¹ç›®å½•
          mv "$REPO_ROOT/temp-hexo/public" "$REPO_ROOT/"
          
          # éªŒè¯æœ€ç»ˆç»“æžœ
          echo -e "\n===== æœ€ç»ˆéƒ¨ç½²æ–‡ä»¶åˆ—è¡¨ ====="
          ls -la "$REPO_ROOT/public/" | head -10

      - name: Deploy to GitHub Pages
        run: |
          set -euo pipefail
          REPO_ROOT=$(pwd)
          cd "$REPO_ROOT/public"
          
          # é…ç½® Git èº«ä»½
          git config --global user.name "liudungen"
          git config --global user.email "798695922@qq.com"
          
          # åˆå§‹åŒ–å¹¶æŽ¨é€ gh-pages åˆ†æ”¯
          git init
          git checkout -b gh-pages
          git add -A
          git commit -m "Deploy: $(date +'%Y-%m-%d %H:%M:%S')" || git commit --allow-empty -m "Deploy: $(date +'%Y-%m-%d %H:%M:%S')"
          git push -f "https://liudungen:${{ secrets.HEXO_DEPLOY_TOKEN }}@github.com/liudungen/liudungen.github.io.git" gh-pages
          echo "âœ… æŽ¨é€è‡³ gh-pages åˆ†æ”¯å®Œæˆ"

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          rm -rf temp-hexo
          echo "âœ… éƒ¨ç½²æµç¨‹å®Œæˆï¼ˆä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†ï¼‰"
