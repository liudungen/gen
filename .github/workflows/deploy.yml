name: Deploy Hexo to GitHub Pages
on:
  push:
    branches: [ main ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Setup Node.js 16
        uses: actions/setup-node@v4
        with:
          node-version: '16'
          cache: 'npm'

      - name: å¼ºåˆ¶åˆå§‹åŒ– Hexo ç¯å¢ƒï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
        run: |
          # 1. åˆ é™¤æ—§ä¸´æ—¶ç›®å½•ï¼Œé¿å…æ®‹ç•™
          rm -rf temp-hexo
          # 2. åˆå§‹åŒ–æ ‡å‡† Hexo é¡¹ç›®ï¼ˆè¿™æ˜¯å…³é”®ï¼šå¾—åˆ°èƒ½æ­£å¸¸æ‰§è¡Œ generate çš„ç¯å¢ƒï¼‰
          hexo init temp-hexo
          cd temp-hexo
          
          # 3. åˆ›å»ºæ–‡ç« ç›®å½•ï¼Œå¤åˆ¶ä½ çš„ test.md
          mkdir -p source/_posts
          cp -r ../source/_posts/* source/_posts/
          
          # 4. å¤åˆ¶ä½ çš„é…ç½®æ–‡ä»¶
          cp ../_config.yml _config.yml
          
          # 5. å®‰è£…ä¾èµ–ï¼ˆç¡®ä¿ç”Ÿæˆå‘½ä»¤å¯ç”¨ï¼‰
          npm config set registry https://registry.npmmirror.com
          npm install hexo-cli -g --force
          npm install --legacy-peer-deps --force
          npm install hexo-renderer-pug hexo-renderer-stylus --save --force

          # 6. éªŒè¯æ–‡ç« æ˜¯å¦å¤åˆ¶æˆåŠŸï¼ˆçœ‹æ—¥å¿—é‡Œæœ‰æ²¡æœ‰ test.mdï¼‰
          echo "ğŸ” Hexo ç›®å½•ä¸‹çš„æ–‡ç« "
          ls -la source/_posts/
          
          # 7. å¼ºåˆ¶ç”Ÿæˆé™æ€æ–‡ä»¶
          hexo clean && echo "âœ… æ¸…ç†ç¼“å­˜æˆåŠŸ"
          hexo generate --force && echo "âœ… ç”Ÿæˆé™æ€æ–‡ä»¶æˆåŠŸ"

          # 8. éªŒè¯ç”Ÿæˆç»“æœï¼ˆçœ‹æœ‰æ²¡æœ‰ 2025/12/03 ç›®å½•ï¼‰
          echo "ğŸ” Hexo ç”Ÿæˆçš„ 2025/12 ç›®å½•"
          ls -la public/2025/12/
          
          # 9. æŠŠç”Ÿæˆçš„ public å¤åˆ¶å›åŸè·¯å¾„ï¼Œæ–¹ä¾¿æ¨é€
          cp -r public ../public

      - name: éªŒè¯æœ€ç»ˆç”Ÿæˆç»“æœ
        run: |
          echo "ğŸ” æœ€ç»ˆè¦æ¨é€çš„ public ç›®å½•å†…å®¹"
          ls -la public/2025/12/
          ls -la public/css/

      - name: Deploy to Pages
        run: |
          git config --global user.name "liudungen"
          git config --global user.email "798695922@qq.com"
          
          cd public
          git init
          git branch -m main
          git add .
          git commit -m "Deploy: $(date +'%Y-%m-%d %H:%M:%S')"
          git push -f "https://liudungen:${{ secrets.HEXO_DEPLOY_TOKEN }}@github.com/liudungen/liudungen.github.io.git" main
