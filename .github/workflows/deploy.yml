name: Deploy Hexo to GitHub Pages
on:
  push:
    branches: [ main ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Setup Node.js 16
        uses: actions/setup-node@v4
        with:
          node-version: '16'
          cache: 'npm'

      - name: å®‰è£… Hexo å¹¶åˆå§‹åŒ–ç¯å¢ƒï¼ˆè§£å†³ command not foundï¼‰
        run: |
          # 1. å…¨å±€å®‰è£… Hexoï¼Œç¡®ä¿å‘½ä»¤å¯ç”¨
          npm config set registry https://registry.npmmirror.com
          npm install hexo-cli -g --force
          # 2. æŸ¥çœ‹ Hexo å®‰è£…è·¯å¾„ï¼Œç¡®ä¿å‘½ä»¤èƒ½è¢«æ‰¾åˆ°
          echo "ğŸ” Hexo å®‰è£…è·¯å¾„"
          which hexo
          # 3. åˆ é™¤æ—§ä¸´æ—¶ç›®å½•
          rm -rf temp-hexo
          # 4. ç”¨ç»å¯¹è·¯å¾„æ‰§è¡Œ hexo initï¼ˆé¿å…å‘½ä»¤æ‰¾ä¸åˆ°ï¼‰
          $(which hexo) init temp-hexo
          cd temp-hexo
          
          # 5. å®‰è£…é¡¹ç›®ä¾èµ–
          npm install --legacy-peer-deps --force
          npm install hexo-renderer-pug hexo-renderer-stylus --save --force

          # 6. åˆ›å»ºæ–‡ç« ç›®å½•å¹¶å¤åˆ¶ test.md
          mkdir -p source/_posts
          cp -r ../source/_posts/* source/_posts/
          echo "ğŸ” Hexo ç›®å½•ä¸‹çš„æ–‡ç« "
          ls -la source/_posts/  # ç¡®è®¤ test.md å­˜åœ¨
          
          # 7. å¤åˆ¶é…ç½®æ–‡ä»¶
          cp ../_config.yml _config.yml

          # 8. ç”Ÿæˆé™æ€æ–‡ä»¶ï¼ˆç”¨ç»å¯¹è·¯å¾„æ‰§è¡Œï¼‰
          echo "âœ… å¼€å§‹æ¸…ç†ç¼“å­˜"
          $(which hexo) clean
          echo "âœ… å¼€å§‹ç”Ÿæˆæ–‡ä»¶"
          $(which hexo) generate --force
          
          # 9. éªŒè¯ç”Ÿæˆç»“æœ
          echo "ğŸ” Hexo ç”Ÿæˆçš„ 2025/12 ç›®å½•"
          ls -la public/2025/12/
          
          # 10. å¤åˆ¶ public ç›®å½•å›åŸè·¯å¾„
          cp -r public ../public

      - name: éªŒè¯æœ€ç»ˆç”Ÿæˆç»“æœ
        run: |
          echo "ğŸ” æœ€ç»ˆ public/2025/12 ç›®å½•"
          ls -la public/2025/12/
          echo "ğŸ” æœ€ç»ˆ public/css ç›®å½•"
          ls -la public/css/

      - name: Deploy to Pages
        run: |
          git config --global user.name "liudungen"
          git config --global user.email "798695922@qq.com"
          
          cd public
          git init
          git branch -m main
          git add .
          git commit -m "Deploy: $(date +'%Y-%m-%d %H:%M:%S')"
          git push -f "https://liudungen:${{ secrets.HEXO_DEPLOY_TOKEN }}@github.com/liudungen/liudungen.github.io.git" main
