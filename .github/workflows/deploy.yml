name: Deploy Hexo to GitHub Pages
on:
  push:
    branches: [ main ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 安装 Hexo 并生成静态文件
        run: |
          # 设置 npm 镜像
          npm config set registry https://registry.npmmirror.com
          
          # 全局安装 Hexo CLI
          npm install hexo-cli@4.3.2 -g
          
          # 清理旧目录
          rm -rf temp-hexo
          
          # 初始化 Hexo
          hexo init temp-hexo
          cd temp-hexo
          
          # 安装特定版本 Hexo
          npm install hexo@8.1.1 --legacy-peer-deps
          npm install hexo-renderer-pug hexo-renderer-stylus --save
          
          # 复制文章和配置
          mkdir -p source/_posts
          cp -r ../source/_posts/* source/_posts/
          cp ../_config.yml _config.yml
          
          # 生成静态文件
          hexo clean
          hexo generate --force
          
          # 验证生成
          echo "生成的文件列表:"
          ls -la public/2025/12/ || echo "2025/12 目录可能不存在"

      - name: 准备部署目录
        run: |
          # 回到仓库根目录
          cd ..
          # 清理旧的 public 目录
          rm -rf public
          # 将生成的静态文件移动到根目录
          mv temp-hexo/public .
          
          # 验证最终结果
          echo "最终生成的文件:"
          ls -la public/ || echo "public 目录为空"

      - name: Deploy to GitHub Pages
        run: |
          git config --global user.name "liudungen"
          git config --global user.email "798695922@qq.com"
          
          # 设置部署分支为 gh-pages（GitHub Pages 默认）
          cd public
          git init
          git checkout -b gh-pages
          git add .
          git commit -m "Deploy: $(date +'%Y-%m-%d %H:%M:%S')"
          # 推送到 gh-pages 分支
          git push -f "https://liudungen:${{ secrets.HEXO_DEPLOY_TOKEN }}@github.com/liudungen/liudungen.github.io.git" gh-pages

      - name: 清理临时文件
        run: |
          rm -rf temp-hexo
          echo "✅ 部署完成"