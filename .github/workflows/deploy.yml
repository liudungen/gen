name: Deploy Hexo to GitHub Pages
on:
  push:
    branches: [ main ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout source (å¸¦å®Œæ•´å†å²)
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Setup Node.js 16 (å…¼å®¹ Hexo)
        uses: actions/setup-node@v4
        with:
          node-version: '16'
          cache: 'npm'

      - name: Install Dependencies
        run: |
          npm config set registry https://registry.npmmirror.com
          npm install hexo-cli -g --force
          npm install --legacy-peer-deps --force
          npm install hexo-renderer-pug hexo-renderer-stylus --save --force

      - name: Build Static Files (ä¿®å¤å‘½ä»¤é¡ºåºï¼Œç¡®ä¿ç”Ÿæˆ)
        run: |
          echo "ğŸ” æŸ¥çœ‹ Hexo é…ç½®æ–‡ä»¶"
          ls -la _config.yml || echo "_config.yml ä¸å­˜åœ¨ï¼"
          echo "ğŸ” æŸ¥çœ‹æ–‡ç« ç›®å½•"
          ls -la source/_posts/ || echo "source/_posts ç›®å½•ä¸å­˜åœ¨ï¼"
          
          # å…³é”®ä¿®å¤ï¼šå…ˆæ‰§è¡Œ hexo ç‰ˆæœ¬éªŒè¯ï¼Œç¡®ä¿ hexo å‘½ä»¤å¯ç”¨
          hexo -v
          # å…ˆæ¸…ç¼“å­˜ï¼Œå†ç”Ÿæˆï¼ˆå»æ‰ --debug é¿å…æ—¥å¿—æº¢å‡ºï¼Œä¿ç•™æ ¸å¿ƒè¾“å‡ºï¼‰
          hexo clean
          hexo generate
          
          # éªŒè¯ç”Ÿæˆç»“æœï¼ˆé‡ç‚¹æ£€æŸ¥æ–°æ–‡ç« å’Œ custom ç›®å½•ï¼‰
          echo "ğŸ” public ç›®å½•ä¸‹ 2025/12 å†…å®¹ï¼ˆæ–°æ–‡ç« æ˜¯å¦ç”Ÿæˆï¼‰"
          ls -la public/2025/12/ || echo "2025/12 ç›®å½•ä¸å­˜åœ¨ï¼"
          echo "ğŸ” public/css ç›®å½•å†…å®¹ï¼ˆcustom æ˜¯å¦åŒæ­¥ï¼‰"
          ls -la public/css/ || echo "css ç›®å½•ä¸å­˜åœ¨ï¼"
          
          # å¼ºåˆ¶æ£€æŸ¥ public ç›®å½•éç©º
          if [ $(ls -1 public/ | wc -l) -eq 0 ]; then
            echo "âŒ ERROR: public ç›®å½•ä¸ºç©ºï¼"
            exit 1
          fi

      - name: Deploy to Pages
        run: |
          git config --global user.name "liudungen"
          git config --global user.email "798695922@qq.com"
          
          cd public
          git init
          git branch -m main
          git add .
          git commit -m "Deploy: $(date +'%Y-%m-%d %H:%M:%S')"
          git push -f "https://liudungen:${{ secrets.HEXO_DEPLOY_TOKEN }}@github.com/liudungen/liudungen.github.io.git" main
