name: Deploy Hexo to GitHub Pages
on:
  push:
    branches: [ main ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Setup Node.js 16
        uses: actions/setup-node@v4
        with:
          node-version: '16'
          cache: 'npm'

      - name: Install Dependencies
        run: |
          npm config set registry https://registry.npmmirror.com
          npm install hexo-cli -g --force
          npm install --legacy-peer-deps --force
          npm install hexo-renderer-pug hexo-renderer-stylus --save --force

      - name: Build Static Files (ç»ˆæä¿®å¤ï¼šç‹¬ç«‹æ‰§è¡Œç”Ÿæˆå‘½ä»¤)
        run: |
          echo "ğŸ” éªŒè¯ç¯å¢ƒå’Œæ–‡ä»¶"
          ls -la _config.yml
          ls -la source/_posts/
          hexo -v  # å†æ¬¡éªŒè¯ Hexo å¯ç”¨

          # å…³é”®ä¿®å¤ï¼šæ¯ä¸ª Hexo å‘½ä»¤å•ç‹¬æ‰§è¡Œï¼ŒåŠ  && ç¡®ä¿å‰ä¸€ä¸ªæˆåŠŸå†æ‰§è¡Œä¸‹ä¸€ä¸ª
          hexo clean && echo "âœ… æ¸…ç†ç¼“å­˜æˆåŠŸ"
          hexo generate && echo "âœ… ç”Ÿæˆé™æ€æ–‡ä»¶æˆåŠŸ"

          # éªŒè¯ç”Ÿæˆç»“æœ
          echo "ğŸ” æ–°æ–‡ç« æ˜¯å¦ç”Ÿæˆï¼ˆæŸ¥çœ‹ 2025/12 ç›®å½•ï¼‰"
          ls -la public/2025/12/
          echo "ğŸ” css/_custom æ˜¯å¦åŒæ­¥"
          ls -la public/css/

          # å¼ºåˆ¶æ£€æŸ¥ï¼šæ²¡æœ‰ 2025/12/03 ç›®å½•åˆ™å¤±è´¥ï¼ˆç¡®ä¿æ–°æ–‡ç« ç”Ÿæˆï¼‰
          if [ ! -d "public/2025/12/03" ]; then
            echo "âŒ æ–°æ–‡ç« ç”Ÿæˆå¤±è´¥ï¼public/2025/12/03 ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: Deploy to Pages
        run: |
          git config --global user.name "liudungen"
          git config --global user.email "798695922@qq.com"
          
          cd public
          git init
          git branch -m main
          git add .
          git commit -m "Deploy: $(date +'%Y-%m-%d %H:%M:%S')"
          git push -f "https://liudungen:${{ secrets.HEXO_DEPLOY_TOKEN }}@github.com/liudungen/liudungen.github.io.git" main