name: Deploy Hexo to GitHub Pages
on:
  push:
    branches: [ main ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£… Hexo å¹¶ç”Ÿæˆé™æ€æ–‡ä»¶
        run: |
          set -euo pipefail  # ä¸¥æ ¼æ¨¡å¼ï¼šå‡ºé”™ç«‹å³é€€å‡ºï¼Œæ•è·æœªå®šä¹‰å˜é‡
          # é”šå®šä»“åº“æ ¹ç›®å½•
          REPO_ROOT=$(pwd)
          echo "âœ… ä»“åº“æ ¹ç›®å½•: $REPO_ROOT"
          
          # è®¾ç½® npm é•œåƒ
          npm config set registry https://registry.npmmirror.com
          
          # å…¨å±€å®‰è£… Hexo CLI
          npm install hexo-cli@4.3.2 -g
          
          # æ¸…ç†æ—§ç›®å½•
          rm -rf "$REPO_ROOT/temp-hexo"
          
          # åˆå§‹åŒ– Hexoï¼ˆæŒ‡å®šé»˜è®¤ä¸»é¢˜ï¼Œé¿å…ä¸»é¢˜ç¼ºå¤±ï¼‰
          hexo init "$REPO_ROOT/temp-hexo" --theme landscape
          cd "$REPO_ROOT/temp-hexo"
          
          # å®‰è£… Hexo æ ¸å¿ƒä¾èµ– + é»˜è®¤ä¸»é¢˜ï¼ˆè§£å†³ layout ç¼ºå¤±ï¼‰
          npm install hexo@8.1.1 --legacy-peer-deps
          npm install hexo-renderer-pug hexo-renderer-stylus --save
          npm install hexo-theme-landscape --save
          
          # å¤‡ä»½é»˜è®¤é…ç½®ï¼Œå¤åˆ¶è‡ªå®šä¹‰é…ç½®ï¼ˆå®¹é”™ï¼‰
          cp _config.yml _config.default.yml
          if [ -f "$REPO_ROOT/_config.yml" ]; then
            cp "$REPO_ROOT/_config.yml" _config.yml
            # å¼ºåˆ¶ä¿®å¤ä¸»é¢˜é…ç½®ï¼Œé¿å…è‡ªå®šä¹‰é…ç½®è¦†ç›–
            sed -i 's/^theme:.*/theme: landscape/' _config.yml
            echo "âœ… å·²è¦†ç›–è‡ªå®šä¹‰é…ç½®çš„ theme å­—æ®µä¸º landscape"
          fi
          
          # è¡¥å……å…³é”®é…ç½®ï¼ˆä¿®å¤ permalinkã€æ—¶åŒºã€æœªæ¥æ–‡ç« ç”Ÿæˆï¼‰
          echo "=== æ·»åŠ å…³é”®é…ç½® ==="
          cat >> _config.yml << 'EOF'

# URL ä¸è·¯å¾„é…ç½®
permalink: :year/:month/:title/
pretty_urls:
  enable: true
  trailing_index: true
  trailing_html: true

# å†…å®¹ç”Ÿæˆé…ç½®
future: true          # ç”Ÿæˆæœªæ¥æ—¥æœŸçš„æ–‡ç« 
publish_drafts: false # ä¸å‘å¸ƒè‰ç¨¿
disable_date: false   # ä¿ç•™æ—¥æœŸå­—æ®µ

# æ—¶åŒºä¸è¯­è¨€
timezone: Asia/Shanghai
language: zh-CN

# ä¸»é¢˜å¢å¼ºé…ç½®ï¼ˆè§£å†³ landscape ä¸»é¢˜æ¸²æŸ“é—®é¢˜ï¼‰
theme: landscape
EOF
          
          # å¤åˆ¶æ–‡ç« ï¼ˆå®Œæ•´å®¹é”™é€»è¾‘ï¼‰
          mkdir -p source/_posts
          echo "=== å¤åˆ¶æ–‡ç« æ–‡ä»¶ ==="
          if [ -d "$REPO_ROOT/source/_posts" ] && [ "$(ls -A "$REPO_ROOT/source/_posts/")" ]; then
            echo "ğŸ“„ æºæ–‡ç« åˆ—è¡¨:"
            ls -la "$REPO_ROOT/source/_posts/"
            cp -r "$REPO_ROOT/source/_posts/"* source/_posts/
            echo "âœ… æ–‡ç« å¤åˆ¶å®Œæˆ"
          else
            echo "âš ï¸  æ— è‡ªå®šä¹‰æ–‡ç« ï¼Œåˆ›å»ºæµ‹è¯•æ–‡ç« "
            cat > source/_posts/æµ‹è¯•æ–‡ç« .md << 'EOF'
---
title: æµ‹è¯•æ–‡ç« 
date: 2025-12-03 16:00:00
tags: [Hexo, æµ‹è¯•]
categories: æ—¥è®°
layout: post  # æ˜¾å¼æŒ‡å®šå¸ƒå±€ï¼Œé¿å… No layout è­¦å‘Š
---
è¿™æ˜¯ GitHub Actions è‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯•æ–‡ç« ã€‚
éªŒè¯è·¯å¾„ï¼š2025/12/æµ‹è¯•æ–‡ç« /
éªŒè¯å¸ƒå±€ï¼špostï¼ˆlandscape ä¸»é¢˜é»˜è®¤å¸ƒå±€ï¼‰
EOF
          fi
          
          # å¼ºåˆ¶ä¿®å¤ä¸»é¢˜ç›®å½•ï¼ˆç¡®ä¿å¸ƒå±€æ¨¡æ¿å®Œæ•´ï¼‰
          if [ ! -d "themes/landscape" ] || [ ! -f "themes/landscape/layout/post.ejs" ]; then
            echo "âš ï¸  landscape ä¸»é¢˜ç¼ºå¤±ï¼Œé‡æ–°å…‹éš†"
            rm -rf themes/landscape
            git clone https://github.com/hexojs/hexo-theme-landscape.git themes/landscape
            # éªŒè¯æ ¸å¿ƒå¸ƒå±€æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f "themes/landscape/layout/post.ejs" ]; then
              echo "âŒ landscape ä¸»é¢˜æ ¸å¿ƒå¸ƒå±€æ–‡ä»¶ç¼ºå¤±ï¼Œéƒ¨ç½²ç»ˆæ­¢"
              exit 1
            fi
          fi
          
          # è°ƒè¯•ä¿¡æ¯ï¼ˆå®šä½é—®é¢˜ç”¨ï¼‰
          echo -e "\n=== è°ƒè¯•ä¿¡æ¯ ==="
          echo "ğŸ“ æ–‡ç« åˆ—è¡¨ä¸ Front-matter:"
          for file in source/_posts/*.md; do
            if [ -f "$file" ]; then
              echo -e "\næ–‡ä»¶: $(basename "$file")"
              grep -E '^title:|^date:|^layout:|^categories:' "$file"
            fi
          done
          
          echo -e "\nâš™ï¸  å…³é”®é…ç½®é¡¹:"
          grep -E 'permalink|future|theme|timezone|language' _config.yml
          
          # ç”Ÿæˆé™æ€æ–‡ä»¶ï¼ˆå¢åŠ è°ƒè¯•æ—¥å¿—ï¼Œå®šä½å¸ƒå±€é—®é¢˜ï¼‰
          echo -e "\n=== å¼€å§‹ç”Ÿæˆé™æ€æ–‡ä»¶ ==="
          hexo clean
          hexo generate --force --debug
          
          # éªŒè¯ç”Ÿæˆç»“æœ
          echo -e "\n===== ç”Ÿæˆçš„é™æ€æ–‡ä»¶åˆ—è¡¨ï¼ˆå‰20ä¸ªï¼‰====="
          find public -type f -name "*.html" | head -20 || echo "âš ï¸  æœªç”Ÿæˆ HTML æ–‡ä»¶"
          
          echo -e "\n===== æ—¥æœŸç›®å½•ç»“æ„ ====="
          find public -type d -name "202*" | sort || echo "âš ï¸  æ— 202xæ—¥æœŸç›®å½•"
          
          if [ ! -d "public" ] || [ -z "$(ls -A public)" ]; then
            echo "âŒ Hexo ç”Ÿæˆå¤±è´¥ï¼Œpublic ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
            exit 1
          fi

      - name: å‡†å¤‡éƒ¨ç½²ç›®å½•
        run: |
          set -euo pipefail
          REPO_ROOT=$(pwd)
          echo "âœ… å½“å‰ä»“åº“æ ¹ç›®å½•: $REPO_ROOT"
          
          # æ¸…ç†æ—§çš„ public ç›®å½•
          rm -rf "$REPO_ROOT/public"
          
          # éªŒè¯ temp-hexo/public å­˜åœ¨
          if [ ! -d "$REPO_ROOT/temp-hexo/public" ]; then
            echo "âŒ temp-hexo/public ç›®å½•ä¸å­˜åœ¨ï¼Œéƒ¨ç½²ç»ˆæ­¢"
            exit 1
          fi
          
          # ç§»åŠ¨é™æ€æ–‡ä»¶åˆ°æ ¹ç›®å½•
          mv "$REPO_ROOT/temp-hexo/public" "$REPO_ROOT/"
          
          # éªŒè¯æœ€ç»ˆç»“æœ
          echo -e "\n===== æœ€ç»ˆéƒ¨ç½²æ–‡ä»¶åˆ—è¡¨ ====="
          echo "ğŸ“„ é¦–é¡µæ–‡ä»¶:"
          ls -la "$REPO_ROOT/public/index.html" 2>/dev/null || echo "âš ï¸  æ— é¦–é¡µæ–‡ä»¶"
          echo -e "\nğŸ“ 2025å¹´ç›®å½•:"
          ls -la "$REPO_ROOT/public/2025/" 2>/dev/null || echo "âš ï¸  æ— 2025å¹´ç›®å½•"

      - name: Deploy to GitHub Pages
        run: |
          set -euo pipefail
          REPO_ROOT=$(pwd)
          cd "$REPO_ROOT/public"
          
          # é…ç½® Git èº«ä»½
          git config --global user.name "liudungen"
          git config --global user.email "798695922@qq.com"
          
          # åˆå§‹åŒ–å¹¶æ¨é€ gh-pages åˆ†æ”¯
          git init
          git checkout -b gh-pages
          git add -A
          # å¤„ç†ç©ºæäº¤ï¼ˆé¿å…æ— æ–‡ä»¶æ—¶å¤±è´¥ï¼‰
          git commit -m "Deploy: $(date +'%Y-%m-%d %H:%M:%S')" || git commit --allow-empty -m "Deploy: $(date +'%Y-%m-%d %H:%M:%S')"
          # æ¨é€ï¼ˆå¼ºåˆ¶è¦†ç›–ï¼Œç¡®ä¿æœ€æ–°ï¼‰
          git push -f "https://liudungen:${{ secrets.HEXO_DEPLOY_TOKEN }}@github.com/liudungen/liudungen.github.io.git" gh-pages
          echo "âœ… æ¨é€è‡³ gh-pages åˆ†æ”¯å®Œæˆ"

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()  # æ— è®ºå‰é¢æ­¥éª¤æ˜¯å¦å¤±è´¥ï¼Œéƒ½æ¸…ç†
        run: |
          rm -rf temp-hexo
          echo "âœ… éƒ¨ç½²æµç¨‹å®Œæˆï¼ˆä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†ï¼‰"
