name: Deploy Hexo to GitHub Pages
on:
  push:
    branches: [ main ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Setup Node.js 20ï¼ˆå…¼å®¹ Hexo 8.xï¼‰
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # å…³é”®ï¼šæ¢æˆ Node.js 20
          cache: 'npm'

      - name: å®‰è£… Hexo å¹¶åˆå§‹åŒ–ç¯å¢ƒï¼ˆç‰ˆæœ¬å…¼å®¹ï¼‰
        run: |
          # 1. å…¨å±€å®‰è£… Hexoï¼ˆé”å®š 8.1.1 ç‰ˆæœ¬ï¼Œé¿å…è‡ªåŠ¨å‡çº§ï¼‰
          npm config set registry https://registry.npmmirror.com
          npm install hexo-cli@4.3.2 -g --force  # é”å®š CLI ç‰ˆæœ¬
          echo "ğŸ” Hexo å®‰è£…è·¯å¾„"
          which hexo
          
          # 2. åˆ é™¤æ—§ä¸´æ—¶ç›®å½•
          rm -rf temp-hexo
          
          # 3. åˆå§‹åŒ– Hexo é¡¹ç›®
          $(which hexo) init temp-hexo
          cd temp-hexo
          
          # 4. é”å®š Hexo æ ¸å¿ƒç‰ˆæœ¬ï¼ˆé¿å…å…¼å®¹é—®é¢˜ï¼‰
          npm install hexo@8.1.1 --legacy-peer-deps --force
          npm install hexo-renderer-pug hexo-renderer-stylus --save --force

          # 5. å¤åˆ¶æ–‡ç« ï¼ˆtest.md å·²å­˜åœ¨ï¼‰
          mkdir -p source/_posts
          cp -r ../source/_posts/* source/_posts/
          echo "ğŸ” Hexo ç›®å½•ä¸‹çš„æ–‡ç« "
          ls -la source/_posts/
          
          # 6. å¤åˆ¶é…ç½®æ–‡ä»¶
          cp ../_config.yml _config.yml

          # 7. ç”Ÿæˆé™æ€æ–‡ä»¶ï¼ˆç»ˆäºèƒ½æ­£å¸¸æ‰§è¡Œäº†ï¼ï¼‰
          echo "âœ… æ¸…ç†ç¼“å­˜"
          $(which hexo) clean
          echo "âœ… ç”Ÿæˆé™æ€æ–‡ä»¶"
          $(which hexo) generate --force
          
          # 8. éªŒè¯ç”Ÿæˆç»“æœï¼ˆå…³é”®çœ‹ 2025/12/03ï¼‰
          echo "ğŸ” Hexo ç”Ÿæˆçš„ 2025/12 ç›®å½•"
          ls -la public/2025/12/
          
          # 9. å¤åˆ¶ public ç›®å½•å›åŸè·¯å¾„
          cp -r temp-hexo/public/* ../

      - name: éªŒè¯æœ€ç»ˆç”Ÿæˆç»“æœ
        run: |
          echo "ğŸ” æœ€ç»ˆ public/2025/12 ç›®å½•"
          ls -la public/2025/12/
          echo "ğŸ” æœ€ç»ˆ public/css ç›®å½•"
          ls -la public/css/

      - name: Deploy to Pages
        run: |
          git config --global user.name "liudungen"
          git config --global user.email "798695922@qq.com"
          
          cd public
          git init
          git branch -m main
          git add .
          git commit -m "Deploy: $(date +'%Y-%m-%d %H:%M:%S')"
          git push -f "https://liudungen:${{ secrets.HEXO_DEPLOY_TOKEN }}@github.com/liudungen/liudungen.github.io.git" main
