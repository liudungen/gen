name: Deploy Hexo to GitHub Pages
on:
  push:
    branches: [ main ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout source (å¸¦å®Œæ•´å†å²ï¼Œé¿å…ä¾èµ–ç¼ºå¤±)
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0  # æ‹‰å–å®Œæ•´ä»“åº“å†å²ï¼Œè§£å†³ Hexo ä¾èµ–çš„æ–‡ä»¶è¯»å–é—®é¢˜

      - name: Setup Node.js 16 (å…¼å®¹ Hexo)
        uses: actions/setup-node@v4
        with:
          node-version: '16'
          cache: 'npm'

      - name: Install Dependencies (å¼ºåˆ¶å®‰è£…ï¼Œé¿å…ç‰ˆæœ¬å†²çª)
        run: |
          npm config set registry https://registry.npmmirror.com
          npm install hexo-cli -g --force  # å¼ºåˆ¶å®‰è£… Hexo  CLI
          npm install --legacy-peer-deps --force  # å¼ºåˆ¶è§£å†³ä¾èµ–å†²çª
          npm install hexo-renderer-pug hexo-renderer-stylus --save --force

      - name: Build Static Files (è¯¦ç»†æ—¥å¿—ï¼Œç¡®ä¿ç”ŸæˆæˆåŠŸ)
        run: |
          echo "ğŸ” æŸ¥çœ‹ Hexo é…ç½®æ–‡ä»¶"
          ls -la _config.yml || echo "_config.yml ä¸å­˜åœ¨ï¼"
          echo "ğŸ” æŸ¥çœ‹æ–‡ç« ç›®å½•"
          ls -la source/_posts/ || echo "source/_posts ç›®å½•ä¸å­˜åœ¨ï¼"
          
          hexo clean
          hexo generate --debug  # å¼€å¯ debug æ—¥å¿—ï¼Œè¾“å‡ºç”Ÿæˆç»†èŠ‚
          
          echo "ğŸ” ç”Ÿæˆå public ç›®å½•å†…å®¹"
          ls -la public/ || echo "âŒ public ç›®å½•æœªç”Ÿæˆï¼"
          # æ£€æŸ¥ public ç›®å½•æ˜¯å¦æœ‰æ–‡ä»¶ï¼ˆè‡³å°‘æœ‰ index.html ç­‰æ ¸å¿ƒæ–‡ä»¶ï¼‰
          if [ $(ls -1 public/ | wc -l) -eq 0 ]; then
            echo "âŒ ERROR: public ç›®å½•ä¸ºç©ºï¼Œç”Ÿæˆé™æ€æ–‡ä»¶å¤±è´¥ï¼"
            exit 1
          fi

      - name: Deploy to Pages (ç¡®ä¿æœ‰æ–‡ä»¶å¯æ¨é€)
        run: |
          git config --global user.name "liudungen"
          git config --global user.email "798695922@qq.com"
          
          cd public
          git init
          git branch -m main  # å¼ºåˆ¶åˆ›å»º main åˆ†æ”¯ï¼ˆé¿å…åˆ†æ”¯ä¸å­˜åœ¨ï¼‰
          git add .  # æ·»åŠ æ‰€æœ‰ç”Ÿæˆçš„é™æ€æ–‡ä»¶
          git commit -m "Deploy: $(date +'%Y-%m-%d %H:%M:%S')"  # å¿…é¡»æœ‰æäº¤å†…å®¹
          
          # ç›´æ¥ç”¨ Secret æ‹¼æ¥ URLï¼Œè®¤è¯å·²ç¡®è®¤æœ‰æ•ˆ
          git push -f "https://liudungen:${{ secrets.HEXO_DEPLOY_TOKEN }}@github.com/liudungen/liudungen.github.io.git" main