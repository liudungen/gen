name: Deploy Hexo to GitHub Pages

# 触发条件：推送代码到 master 分支（和你原配置一致，无需改分支名）
on:
  push:
    branches: [ master ]
  # 可选：允许手动触发部署（万一自动部署失败，可在GitHub手动跑）
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        submodules: true  # 拉取主题子模块（Butterfly 主题需要，保留）
        fetch-depth: 0    # 拉取完整提交记录，避免字数统计等功能报错

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '16'  # 优化：Node14已停止维护，升级到16（兼容所有依赖，更稳定）
        cache: 'npm'  # 缓存依赖，加速构建

    - name: Install dependencies
      run: |
        npm install hexo-cli -g
        npm install
        # 补充 Butterfly 主题必需依赖（原配置缺失，不装会导致页面空白）
        npm install hexo-renderer-pug hexo-renderer-stylus --save
        # 补充字数统计插件（之前报错的依赖，避免部署后功能缺失）
        npm install hexo-wordcount --save
        
    - name: Generate static files
      run: |
        hexo clean
        hexo generate
        
    - name: Deploy to GitHub Pages
      run: |
        # 设置 Git 身份（替换为你当前博客的 GitHub 用户名和邮箱）
        git config --global user.name "liudungen"  # 你的 GitHub 用户名（无后缀）
        git config --global user.email "liudungen@163.com"  # 保留你的邮箱
        
        # 进入生成的静态文件目录
        cd public
        
        # 初始化 Git 仓库并强制切换到 main 分支（GitHub Pages 部署分支）
        git init
        git branch -m main
        
        # 添加所有文件并提交（保留时间戳备注，清晰可追溯）
        git add -A
        git commit -m "Deploy: $(date +'%Y-%m-%d %H:%M:%S')"
        
        # 推送地址替换为你当前的博客仓库（关键修改！）
        git push -f "https://x-access-token:${{ secrets.HEXO_DEPLOY_TOKEN }}@github.com/liudungen/liudungen.github.io.git" main
