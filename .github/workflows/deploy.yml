name: Deploy Hexo to GitHub Pages

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'  # å…¼å®¹ä½ çš„ Hexo ç¯å¢ƒ
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: |
          npm config set registry https://registry.npmmirror.com
          npm install hexo-cli -g
          npm install --legacy-peer-deps
          npm install hexo-renderer-pug hexo-renderer-stylus --save

      - name: Generate static files
        run: |
          hexo clean
          hexo generate --debug

      - name: Check generated files
        run: |
          echo "Checking public directory:"
          ls -la public/ || echo "Public directory not found!"

      - name: Configure Git
        run: |
          git config --global user.name "liudungen"
          git config --global user.email "798695922@qq.com"

      - name: Deploy to GitHub Pages
        run: |
          if [ ! -d "public" ]; then
            echo "ERROR: public directory not found!"
            exit 1
          fi
          cd public
          git init
          git config user.name "liudungen"
          git config user.email "798695922@qq.com"
          git branch -m main
          git add -A
          git commit -m "Deploy: $(date +'%Y-%m-%d %H:%M:%S')"
          # ğŸ‘‡ æ›¿æ¢æˆä½ æœ¬åœ°éªŒè¯æˆåŠŸçš„ã€Œç”¨æˆ·å:ä»¤ç‰Œã€ï¼ˆæ¯”å¦‚ liudungen:ghp_abcdef123456ï¼‰
          git push -f "https://liudungen:ghp_ä½ çš„å®é™…PATä»¤ç‰Œ@github.com/liudungen/liudungen.github.io.git" main
